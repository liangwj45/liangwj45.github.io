<!DOCTYPE html><html lang="zn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="Wenjie Liang, 奥小文的加油站"><meta name="author" content="Wenjie Liang"><meta name="description" content="Ex2：用 CImg 重写 Canny 代码"><meta name="copyright" content="Wenjie Liang"><title>Ex2：用 CImg 重写 Canny 代码 | 奥小文的加油站</title><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/avatar.jpg?v=1.3.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/avatar.jpg?v=1.3.1" type="image/png" sizes="32x32"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=1.3.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  sidebar: {"offsetTop":"20px","renderTocDepth":4},
  back2top: {"enable":true},
  reward: false,
  fancybox: false,
  zoom_image: {"enable":true,"mask_color":"rgba(0,0,0,0.6)"},
  gallery_waterfall: undefined,
  lazyload: undefined,
  external_link: {"icon":{"enable":true,"name":"external-link"}},
  shortcuts: {"switch_post":false},
  prompt: {"copy_success":"复制成功","copy_error":"复制失败","creative_commons":"知识共享","copy_button":"点击复制"}
};

window.CONFIG = CONFIG;</script></head><body><div id="container"><header id="header"><div class="loading-bar"><div class="progress"></div></div><nav class="header-nav"><div class="header-nav-inner"><div class="fa fa-bars header-nav-menu-icon"></div><div class="header-nav-menu"><div class="menu-item"><a class="menu-item-inner" href="/"><i class="fa fa-home"></i>首页</a></div><div class="menu-item"><a class="menu-item-inner" href="/archives/"><i class="fa fa-folder-open"></i>归档</a></div><div class="menu-item"><a class="menu-item-inner" href="/categories/"><i class="fa fa-th"></i>分类</a></div><div class="menu-item"><a class="menu-item-inner" href="/tags/"><i class="fa fa-tags"></i>标签</a></div><div class="menu-item"><a class="menu-item-inner" href="/about/"><i class="fa fa-user"></i>关于</a></div></div></div></nav><div class="header-info"><div class="header-info-inner"><div class="header-info-title">奥小文的加油站</div><div class="header-info-subtitle"></div></div></div></header><main id="main"><div class="main-inner"><aside id="sidebar"><div class="sidebar-inner"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-overview">站点概览</span></div><section class="sidebar-toc"><div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#编写头文件"><span class="toc-number">1.</span> <span class="toc-text"> 编写头文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写源文件"><span class="toc-number">2.</span> <span class="toc-text"> 编写源文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写测试代码"><span class="toc-number">3.</span> <span class="toc-text"> 编写测试代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除短边的优缺点"><span class="toc-number">4.</span> <span class="toc-text"> 删除短边的优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#各参数对结果的影响"><span class="toc-number">5.</span> <span class="toc-text"> 各参数对结果的影响</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序运行结果"><span class="toc-number">6.</span> <span class="toc-text"> 程序运行结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">7.</span> <span class="toc-text"> 总结</span></a></li></ol></div></section><section class="hide sidebar-overview"><div class="sidebar-author"><img class="sidebar-author-avatar" src="/images/avatar.jpg" alt="avatar"><p class="sidebar-author-motto">你今天吃早餐了吗？</p></div><div class="sidebar-social"><span class="sidebar-social-item"><a href="https://github.com/liangwj45" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><i class="fa fa-github"></i></a></span><span class="sidebar-social-item"><a href="liangwj45@mail2.syu.edu.cn" target="_blank" rel="noopener" data-popover="Email" data-popover-pos="up"><i class="fa fa-envelope-o"></i></a></span><span class="sidebar-social-item"><a href="290095633" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><i class="fa fa-qq"></i></a></span></div><div class="sidebar-state"><span class="sidebar-state-item sidebar-state-posts"><a href="/archives/"><div class="sidebar-state-item-count">8</div><div class="sidebar-state-item-name">归档</div></a></span><span class="sidebar-state-item sidebar-state-categories"><a href="/categories/"><div class="sidebar-state-item-count">0</div><div class="sidebar-state-item-name">分类</div></a></span><span class="sidebar-state-item sidebar-state-tags"><a href="/tags/"><div class="sidebar-state-item-count">9</div><div class="sidebar-state-item-name">标签</div></a></span></div></section><div class="sidebar-progress"><div class="sidebar-progress-read"><span>你已阅读了</span><span class="sidebar-progress-number"></span></div><div class="sidebar-progress-line"></div></div></div></aside><div class="content headings code-highlight"><header class="post-header"><h1 class="post-title">Ex2：用 CImg 重写 Canny 代码</h1><div class="post-meta"><span class="post-create"><i class="fa fa-calendar-o"></i><span>发表于 </span><span>2019-09-25</span></span><span class="post-reading-count"><i class="fa fa-eye"></i><span>阅读次数 </span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><h2 id="编写头文件"><a class="markdownIt-Anchor" href="#编写头文件"></a> 编写头文件</h2>
<p>模仿 <code>canny_source.c</code> 写出 Canny 边缘检测算法需要用到的方法，并将源代码中各个方法中的参数改写成 C++ 类中的成员变量，最后补上构造和析构函数。</p>
<a id="more"></a>
<figure class="highlight c++"><div style="overflow: auto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"CImg.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cimg_library;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Canny</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img;</span><br><span class="line">  <span class="built_in">string</span> img_name;     <span class="comment">// The name of the image.</span></span><br><span class="line">  <span class="keyword">int</span> rows;            <span class="comment">// The height of the image.</span></span><br><span class="line">  <span class="keyword">int</span> cols;            <span class="comment">// The width of the image.</span></span><br><span class="line">  <span class="keyword">int</span>* delta_x;        <span class="comment">// The first devivative image, x-direction.</span></span><br><span class="line">  <span class="keyword">int</span>* delta_y;        <span class="comment">// The first derivative image, y-direction.</span></span><br><span class="line">  <span class="keyword">float</span>* dir_radians;  <span class="comment">// Gradient direction image.</span></span><br><span class="line">  <span class="keyword">int</span>* magnitude;      <span class="comment">// The magnitude of the gadient image.</span></span><br><span class="line">  <span class="keyword">int</span>* smoothedim;     <span class="comment">// The image after gaussian smoothing.</span></span><br><span class="line">  <span class="keyword">int</span>* nms;            <span class="comment">// The image after non-maximize suppression.</span></span><br><span class="line">  <span class="keyword">int</span>* edge;           <span class="comment">// The image after hysterresis.</span></span><br><span class="line">  <span class="keyword">int</span>* lconnect;       <span class="comment">// The image after connecting line.</span></span><br><span class="line">  <span class="keyword">int</span>* ldelete;        <span class="comment">// The image after deleting line.</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  Canny(<span class="built_in">string</span> img_name);</span><br><span class="line">  ~Canny();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">canny_edge_detection</span><span class="params">(<span class="keyword">float</span> sigma, <span class="keyword">float</span> tlow, <span class="keyword">float</span> thig, <span class="keyword">int</span> distance)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save_result</span><span class="params">(<span class="built_in">string</span> tag)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">RGB2Gray</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">gaussian_smooth</span><span class="params">(<span class="keyword">float</span> sigma)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">make_gaussian_kernel</span><span class="params">(<span class="keyword">float</span> sigma, <span class="keyword">float</span>** kernel, <span class="keyword">int</span>* windowsize)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">derrivative_x_y</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">magnitude_x_y</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">radian_direction</span><span class="params">(<span class="keyword">int</span> xdirtag, <span class="keyword">int</span> ydirtag)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">angle_radians</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">non_max_supp</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">apply_hysteresis</span><span class="params">(<span class="keyword">float</span> tlow, <span class="keyword">float</span> thigh)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">follow_edges</span><span class="params">(<span class="keyword">int</span>* edgemapptr, <span class="keyword">int</span>* edgemagptr, <span class="keyword">int</span> lowval, <span class="keyword">int</span> cols)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">connect_line</span><span class="params">(<span class="keyword">int</span> distance)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">delete_line</span><span class="params">(<span class="keyword">int</span> distance)</span></span>;</span><br><span class="line"></span><br><span class="line">  CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; matrix2image(<span class="keyword">int</span>* matrix);</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">image2matrix</span><span class="params">(CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img, <span class="keyword">int</span>* matrix)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<h2 id="编写源文件"><a class="markdownIt-Anchor" href="#编写源文件"></a> 编写源文件</h2>
<p>主要编写构造和析构函数，以及连接删除边和保存图片相关的代码，其他部分代码与 <code>canny_source.c</code> 中的基本相同，由于篇幅过大，那部分代码就不放出来了。</p>
<figure class="highlight c++"><div style="overflow: auto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"canny.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> M_PI 3.14159265358979323846</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOSTBLURFACTOR 90.0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NOEDGE 255</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POSSIBLE_EDGE 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDGE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMGPATH <span class="meta-string">"/img/ComputerVision/Ex2/"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cimg_library;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> black[] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">Canny::Canny(<span class="built_in">string</span> img_name) : img_name(img_name) &#123;</span><br><span class="line">  img = CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;(<span class="built_in">string</span>(IMGPATH + img_name).c_str());</span><br><span class="line">  rows = img.height();</span><br><span class="line">  cols = img.width();</span><br><span class="line"></span><br><span class="line">  delta_x = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  delta_y = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  dir_radians = <span class="keyword">new</span> <span class="keyword">float</span>[rows * cols];</span><br><span class="line">  magnitude = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  smoothedim = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  nms = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  edge = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  lconnect = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line">  ldelete = <span class="keyword">new</span> <span class="keyword">int</span>[rows * cols];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(delta_x, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(delta_y, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(dir_radians, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span><br><span class="line">  <span class="built_in">memset</span>(magnitude, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(smoothedim, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(nms, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(edge, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(lconnect, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">  <span class="built_in">memset</span>(ldelete, <span class="number">0</span>, rows * cols * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Canny::~Canny() &#123;</span><br><span class="line">  <span class="keyword">delete</span>[] delta_x;</span><br><span class="line">  <span class="keyword">delete</span>[] delta_y;</span><br><span class="line">  <span class="keyword">delete</span>[] dir_radians;</span><br><span class="line">  <span class="keyword">delete</span>[] magnitude;</span><br><span class="line">  <span class="keyword">delete</span>[] nms;</span><br><span class="line">  <span class="keyword">delete</span>[] edge;</span><br><span class="line">  <span class="keyword">delete</span>[] lconnect;</span><br><span class="line">  <span class="keyword">delete</span>[] ldelete;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Canny::canny_edge_detection(<span class="keyword">float</span> sigma, <span class="keyword">float</span> tlow, <span class="keyword">float</span> thig,</span><br><span class="line">                                 <span class="keyword">int</span> distance) &#123;</span><br><span class="line">  RGB2Gray();</span><br><span class="line">  gaussian_smooth(sigma);</span><br><span class="line">  derrivative_x_y();</span><br><span class="line">  magnitude_x_y();</span><br><span class="line">  radian_direction(<span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">  non_max_supp();</span><br><span class="line">  apply_hysteresis(tlow, thig);</span><br><span class="line"></span><br><span class="line">  connect_line(distance);</span><br><span class="line">  delete_line(distance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Canny::connect_line(<span class="keyword">int</span> distance) &#123;</span><br><span class="line">  CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img = matrix2image(edge);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> isEdge[<span class="number">1000</span>][<span class="number">1000</span>];</span><br><span class="line">  <span class="keyword">int</span> dx[<span class="number">8</span>] = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;, dy[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"></span><br><span class="line">  cimg_forXY(img, x, y) &#123;</span><br><span class="line">    isEdge[x][y] = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (x != rows - <span class="number">1</span> &amp;&amp; x != <span class="number">0</span> &amp;&amp; y != cols - <span class="number">1</span> &amp;&amp; y != <span class="number">0</span> &amp;&amp; img(x, y) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> neighbors[<span class="number">8</span>], m = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> di = x + dx[i], dj = y + dy[i];</span><br><span class="line">        <span class="keyword">if</span> (di != x || dj != y) neighbors[m] = img(di, dj), m++;</span><br><span class="line">      &#125;</span><br><span class="line">      sort(neighbors, neighbors + <span class="number">8</span>);</span><br><span class="line">      isEdge[x][y] = (neighbors[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; neighbors[<span class="number">1</span>] == <span class="number">255</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cimg_forXY(img, x, y) &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= distance &amp;&amp; x &lt;= rows - <span class="number">1</span> - distance &amp;&amp; y &gt;= distance &amp;&amp;</span><br><span class="line">        y &lt;= cols - <span class="number">1</span> - distance &amp;&amp; isEdge[x][y] == <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = x - distance; i &lt;= x + distance; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = y - distance; j &lt;= y + distance; j++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isEdge[i][j] == <span class="literal">true</span>) &#123;</span><br><span class="line">            img.draw_line(x, y, i, j, black);</span><br><span class="line">            isEdge[i][j] = <span class="literal">false</span>, isEdge[x][y] = <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  image2matrix(img, lconnect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Canny::delete_line(<span class="keyword">int</span> distance) &#123;</span><br><span class="line">  CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img = matrix2image(lconnect);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> isEdge[<span class="number">1000</span>][<span class="number">1000</span>];</span><br><span class="line">  <span class="keyword">int</span> dx[<span class="number">8</span>] = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>&#125;, dy[<span class="number">8</span>] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>&#125;;</span><br><span class="line"></span><br><span class="line">  cimg_forXY(img, x, y) &#123;</span><br><span class="line">    isEdge[x][y] = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (x != rows - <span class="number">1</span> &amp;&amp; x != <span class="number">0</span> &amp;&amp; y != cols - <span class="number">1</span> &amp;&amp; y != <span class="number">0</span> &amp;&amp; img(x, y) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> neighbors[<span class="number">8</span>], m = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> di = x + dx[i], dj = y + dy[i];</span><br><span class="line">        <span class="keyword">if</span> (!(di == x &amp;&amp; dj == y)) &#123;</span><br><span class="line">          neighbors[m] = img(di, dj), m++;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sort(neighbors, neighbors + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> (neighbors[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; neighbors[<span class="number">1</span>] == <span class="number">255</span>) isEdge[x][y] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (neighbors[<span class="number">0</span>] == <span class="number">255</span>) img(x, y) = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cimg_forXY(img, x, y) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isEdge[x][y] == <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> beg_x = x - distance &gt; <span class="number">0</span> ? x - distance : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> beg_y = y - distance &gt; <span class="number">0</span> ? y - distance : <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> end_x = x + distance &lt; rows - <span class="number">1</span> ? x + distance : rows - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">int</span> end_y = y + distance &lt; cols - <span class="number">1</span> ? y + distance : cols - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = beg_x; i &lt;= end_x; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = beg_y; j &lt;= end_y; j++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isEdge[i][j]) &#123;</span><br><span class="line">            <span class="keyword">int</span> max_x = x &gt;= i ? x : i;</span><br><span class="line">            <span class="keyword">int</span> max_y = y &gt;= j ? y : j;</span><br><span class="line">            <span class="keyword">int</span> min_x = max_x == x ? i : x;</span><br><span class="line">            <span class="keyword">int</span> min_y = max_y == y ? j : y;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> ii = min_x; ii &lt;= max_x; ii++) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> jj = min_y; jj &lt;= max_y; jj++) &#123;</span><br><span class="line">                img(ii, jj) = <span class="number">255</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            isEdge[i][j] = <span class="literal">false</span>, isEdge[x][y] = <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cimg_forXY(img, x, y) &#123;</span><br><span class="line">    isEdge[x][y] = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (x != rows - <span class="number">1</span> &amp;&amp; x != <span class="number">0</span> &amp;&amp; y != cols - <span class="number">1</span> &amp;&amp; y != <span class="number">0</span> &amp;&amp; img(x, y) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> neighbors[<span class="number">8</span>], m = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> di = x + dx[i], dj = y + dy[i];</span><br><span class="line">        <span class="keyword">if</span> (!(di == x &amp;&amp; dj == y)) neighbors[m] = img(di, dj), m++;</span><br><span class="line">      &#125;</span><br><span class="line">      sort(neighbors, neighbors + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> (neighbors[<span class="number">0</span>] == <span class="number">255</span>) img(x, y) = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  image2matrix(img, ldelete);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Canny::save_result(<span class="built_in">string</span> tag) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">""</span> + <span class="keyword">this</span>-&gt;img_name).c_str() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  img.save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"00-"</span> + <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">  matrix2image(smoothedim).save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"01-guassian-"</span>+ <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">  matrix2image(nms).save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"02-nms-"</span>+ <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">  matrix2image(edge).save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"03-edge-"</span> + <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">  matrix2image(lconnect).save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"04-connect-"</span>+ <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">  matrix2image(ldelete).save(<span class="built_in">string</span>(<span class="string">"./result/"</span> + tag + <span class="string">"05-delete-"</span>+ <span class="keyword">this</span>-&gt;img_name).c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; Canny::matrix2image(<span class="keyword">int</span>* matrix) &#123;</span><br><span class="line">  CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img(rows, cols, <span class="number">1</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">  img.fill(<span class="number">0</span>);</span><br><span class="line">  cimg_forXY(img, x, y) &#123; img(x, y, <span class="number">0</span>) = matrix[x * cols + y]; &#125;</span><br><span class="line">  <span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Canny::image2matrix(CImg&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; img, <span class="keyword">int</span>* matrix) &#123;</span><br><span class="line">  cimg_forXY(img, x, y) &#123; matrix[x * cols + y] = img(x, y, <span class="number">0</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<h2 id="编写测试代码"><a class="markdownIt-Anchor" href="#编写测试代码"></a> 编写测试代码</h2>
<p>编写一个 <code>main.cpp</code> 用于测试。</p>
<figure class="highlight c++"><div style="overflow: auto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"canny.h"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">list</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">stringstream</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  Test(Canny&amp; img) : img(img) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">float</span> sigma, <span class="keyword">float</span> tlow, <span class="keyword">float</span> thig, <span class="keyword">int</span> distance)</span> </span>&#123;</span><br><span class="line">    img.canny_edge_detection(sigma, tlow, thig, distance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="built_in">string</span> tag)</span> </span>&#123; img.save_result(tag); &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  Canny&amp; img;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">list</span>&lt;<span class="built_in">string</span>&gt; images(&#123;<span class="string">"3.bmp"</span>, <span class="string">"4.bmp"</span>, <span class="string">"20160326110137505.bmp"</span>, <span class="string">"bigben.bmp"</span>,</span><br><span class="line">                       <span class="string">"lena.bmp"</span>, <span class="string">"stpietro.bmp"</span>&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> it = images.begin(); it != images.end(); ++it) &#123;</span><br><span class="line">    <span class="function">Canny <span class="title">img</span><span class="params">(*it)</span></span>;</span><br><span class="line">    <span class="function">Test <span class="title">test</span><span class="params">(img)</span></span>;</span><br><span class="line">    test.test(<span class="number">1.5</span>, <span class="number">0.3</span>, <span class="number">0.75</span>, <span class="number">10</span>);</span><br><span class="line">    test.save(<span class="string">""</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>上述代码中四个参数</p>
<ul>
<li><code>float sigma</code>：1.5</li>
<li><code>float tlow</code>：0.3</li>
<li><code>float thig</code>：0.75</li>
<li><code>int distance</code>：10</li>
</ul>
<p>的值是经过多次调参得出的，调参过程的结果可以在 <code>code/result/</code> 目录中查看。</p>
<h2 id="删除短边的优缺点"><a class="markdownIt-Anchor" href="#删除短边的优缺点"></a> 删除短边的优缺点</h2>
<p>删除短边可以去掉一些离散的边缘，减少噪声，但可能会误删真实存在的短边。</p>
<h2 id="各参数对结果的影响"><a class="markdownIt-Anchor" href="#各参数对结果的影响"></a> 各参数对结果的影响</h2>
<ul>
<li>
<p><code>sigma</code> ：Standard deviation of the gaussian kernel.</p>
<blockquote>
<p>标准差减小时，会增加噪声；标准差增大时，原来的强边缘像素大部分被误认为噪声，会造成边缘缺失。</p>
</blockquote>
</li>
<li>
<p><code>tlow</code> ：Fraction of the high threshold in hysteresis.</p>
<blockquote>
<p>低阈值减小时，会增加噪声；低阈值增大时，会丢失强边缘像素。</p>
</blockquote>
</li>
<li>
<p><code>thig</code> ：High hysteresis threshold control. The actual is the (100 * thigh) percentage point the histogram of the magnitude of the image that passes non-maximal.</p>
<blockquote>
<p>高阈值减小时，会增加强边缘像素；高阈值增大时，强边缘像素部分会转化为弱边缘像素，丢失部分边缘像素点。</p>
</blockquote>
</li>
</ul>
<h2 id="程序运行结果"><a class="markdownIt-Anchor" href="#程序运行结果"></a> 程序运行结果</h2>
<p><img src="/img/ComputerVision/Ex2/3.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/3-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/4.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/4-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/20160326110137505.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/20160326110137505-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/bigben.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/bigben-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/lena.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/lena-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/stpietro.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/stpietro-result.bmp" alt></p>
<p><img src="/img/ComputerVision/Ex2/1.png" alt></p>
<p><img src="/img/ComputerVision/Ex2/2.png" alt></p>
<p><img src="/img/ComputerVision/Ex2/3.png" alt></p>
<p><img src="/img/ComputerVision/Ex2/4.png" alt></p>
<p><img src="/img/ComputerVision/Ex2/5.png" alt></p>
<p><img src="/img/ComputerVision/Ex2/6.png" alt></p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>图像经过灰度处理，高斯滤波去噪，应用非极大值压制以及双阈值检测得到的边缘检测结果还算是比较理想，最后加上自己编写的合并相邻的线条和删除短线条，即使通过调参，都没有太明显的效果。</p>
</div><footer class="post-footer"><div class="post-footer-end"><span>------</span><span>本文结束，感谢您的阅读</span><span>------</span></div><div class="post-footer-tags"><i class="fa fa-tags icon"></i><span><a href="/liangwj45.github.io/tags/计算机视觉/" title="计算机视觉">计算机视觉</a></span><span><a href="/liangwj45.github.io/tags/Canny-边缘检测算法/" title="Canny 边缘检测算法">Canny 边缘检测算法</a></span></div><nav id="paginator"><div class="post-paginator"><div class="article-next pull-right"><a href="/2019/09/25/安装 Go 开发环境/"><span class="title">安装 Go 开发环境</span><i class="fa fa-chevron-right"></i></a></div></div></nav></footer></div><div class="clearfix"></div></div></main><footer id="footer"><div class="footer-inner"><div><span>&copy; 2019</span><span> </span><span>Wenjie Liang.</span></div><div class="busuanzi"><span class="busuanzi-uv"><i class="fa fa-user"></i><span>访问人数 </span><span id="busuanzi_value_site_uv"></span></span><span class="separator">|</span><span class="busuanzi-pv"><i class="fa fa-eye"></i><span>浏览总量 </span><span id="busuanzi_value_site_pv"></span></span><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async data-pjax></script></div></div></footer><div id="back-top"><div class="back-top-inner" data-popover="回到顶部" data-popover-pos="up"><i class="fa fa-rocket"></i></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('load', function () {
  var pjax = new Pjax({"elements":["a:not([target=_blank])"],"selectors":["head title","meta[name=description]","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;
  // 是否第一次加载 pjax
  var isFirstLoad = true;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    isFirstLoad = false;

    $('html').velocity('scroll', {
      duration: 500,
      offset: $('#header').height(),
      easing: 'easeInOutCubic'
    });

    var loadingBarWidth = 0;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar .progress').css('transform', 'translateX(-100%)');
    $('.loading-bar').addClass('loading');

    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 2;

      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }

      $('.loading-bar .progress').css(
        'transform', 'translateX(' + (loadingBarWidth - 100) + '%)'
      );
    }, 100);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar .progress').css('transform', 'translateX(0%)');
    setTimeout(function () {
      $('.loading-bar').removeClass('loading');
      $('.loading-bar .progress').css('transform', 'translateX(-100%)');
    }, 400);

    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });

    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    Stun.utils.pjaxReloadBoot();
    Stun.utils.pjaxReloadScroll();
    Stun.utils.pjaxReloadSidebar();
  }, false);
}, false);</script><div id="pjax-reload"></div><script src="/js/utils.js?v=1.3.1"></script><script src="/js/stun-boot.js?v=1.3.1"></script><script src="/js/scroll.js?v=1.3.1"></script><script src="/js/header.js?v=1.3.1"></script><script src="/js/sidebar.js?v=1.3.1"></script></body></html>